<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中国历史地理分区立体地形图</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .map-section {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            padding: 25px;
        }
        #map {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            margin-bottom: 25px;
        }
        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        button.active {
            background-color: #e74c3c;
        }
        .legend {
            background-color: white;
            padding: 18px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            margin-bottom: 25px;
            font-size: 14px;
        }
        .legend h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .legend-color {
            width: 25px;
            height: 25px;
            border-radius: 4px;
            margin-right: 12px;
            opacity: 0.85;
            border: 2px solid rgba(0,0,0,0.2);
        }
        .legend-desc {
            display: flex;
            flex-direction: column;
        }
        .legend-title {
            font-weight: bold;
            color: #2c3e50;
        }
        .legend-subtitle {
            font-size: 12px;
            color: #7f8c8d;
        }
        .region-label {
            pointer-events: none;
            z-index: 1000;
        }
        .region-label div {
            text-align: center;
            line-height: 1;
        }
        .map-info {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
        }
        .map-info h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.3em;
            margin-bottom: 15px;
        }
        .map-info p {
            margin: 0 0 10px 0;
            line-height: 1.7;
        }
        .map-info ul {
            margin: 0;
            padding-left: 20px;
        }
        .map-info li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        .info-popup {
            max-width: 300px;
        }
        .info-popup h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.2em;
            margin-bottom: 10px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        .info-popup h4 {
            margin: 12px 0 6px 0;
            color: #34495e;
            font-size: 1em;
        }
        .info-popup p {
            margin: 0 0 8px 0;
            line-height: 1.6;
            font-size: 0.95em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>中国历史地理分区立体地形图</h1>
        <p class="subtitle">地理环境与历史发展的空间关系可视化</p>

        <div class="map-section">
            <div id="map"></div>
            
            <div class="controls">
                <select id="dataSelect" onchange="changeDataFile()" style="padding: 10px 18px; border-radius: 5px; border: 1px solid #ddd; font-size: 14px; margin-right: 10px;">
                    <option value="geo-data.js" selected>默认地理数据</option>
                    <option value="custom-geo-data.js">自定义地理数据</option>
                </select>
                <button onclick="toggleLayer('natural')" class="active">自然地理单元</button>
                <button onclick="toggleLayer('historical')" class="active">历史文化区域</button>
                <button onclick="toggleLayer('passage')" class="active">地理通道</button>
                <button onclick="toggleLayer('modern')">现代城市名称</button>
                <button onclick="zoomIn()">放大</button>
                <button onclick="zoomOut()">缩小</button>
                <button onclick="centerMap()">居中</button>
                <button onclick="changeMapType()">切换地图类型</button>
            </div>

            <div class="legend">
                <h3>地图图例说明</h3>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(46, 204, 113, 0.6);"></div>
                    <div class="legend-desc">
                        <div class="legend-title">自然地理单元</div>
                        <div class="legend-subtitle">绿色区域 | 点击查看详情</div>
                    </div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(52, 152, 219, 0.6);"></div>
                    <div class="legend-desc">
                        <div class="legend-title">历史文化区域</div>
                        <div class="legend-subtitle">蓝色区域 | 点击查看详情</div>
                    </div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(231, 76, 60, 0.8); background-image: linear-gradient(45deg, #c0392b 25%, transparent 25%, transparent 50%, #c0392b 50%, #c0392b 75%, transparent 75%, transparent); background-size: 10px 10px;"></div>
                    <div class="legend-desc">
                        <div class="legend-title">关键地理通道</div>
                        <div class="legend-subtitle">红色虚线 | 点击查看详情</div>
                    </div>
                </div>
            </div>

            <div class="map-info">
                <h3>地图说明</h3>
                <p>这张地图将地理地形与历史区域结合，清晰展现了中国地理环境对历史发展、区域文化形成的影响。</p>
                <h4>核心功能：</h4>
                <ul>
                    <li>使用立体地形图层展示中国地理地貌</li>
                    <li>标注自然地理单元、历史文化区域和关键地理通道</li>
                    <li>点击区域查看详细的历史文化意义</li>
                    <li>可切换显示不同类型的区域</li>
                    <li>支持缩放、平移等交互操作</li>
                </ul>
                <h4>主要区域：</h4>
                <ul>
                    <li><strong>自然地理单元</strong>：蒙古高原、东北平原、青藏高原、云贵高原等</li>
                    <li><strong>历史文化区域</strong>：西域、河西走廊、关中、巴蜀、中原、江南等</li>
                    <li><strong>地理通道</strong>：河西走廊等</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="geo-data.js"></script>
    <script>
        let map;
        let currentMapType = 1;
        let naturalLayer = L.layerGroup();
        let historicalLayer = L.layerGroup();
        let passageLayer = L.layerGroup();
        let modernAdminLayer = L.layerGroup();
        
        const mapTypes = [
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }),
            L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { 
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
            }),
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }),
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', { 
                attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>'
            })
        ];



        // 现代城市数据
        const modernAdminRegions = [
            { name: '北京', center: [39.9042, 116.4074] },
            { name: '上海', center: [31.2304, 121.4737] },
            { name: '广州', center: [23.1291, 113.2644] },
            { name: '深圳', center: [22.5431, 114.0579] },
            { name: '成都', center: [30.5728, 104.0668] },
            { name: '杭州', center: [30.2741, 120.1551] },
            { name: '武汉', center: [30.5928, 114.3055] },
            { name: '重庆', center: [29.4316, 106.9123] },
            { name: '西安', center: [34.2658, 108.9480] },
            { name: '南京', center: [32.0603, 118.7969] },
            { name: '天津', center: [39.3434, 117.3616] },
            { name: '苏州', center: [31.2989, 120.5853] },
            { name: '郑州', center: [34.7466, 113.6254] },
            { name: '长沙', center: [28.2282, 112.9388] },
            { name: '沈阳', center: [41.8056, 123.4315] },
            { name: '青岛', center: [36.0671, 120.3826] },
            { name: '济南', center: [36.6512, 117.1201] },
            { name: '哈尔滨', center: [45.8038, 126.5349] },
            { name: '福州', center: [26.0745, 119.2965] },
            { name: '昆明', center: [24.8864, 102.8329] },
            { name: '大连', center: [38.9140, 121.6147] },
            { name: '厦门', center: [24.4798, 118.0894] },
            { name: '合肥', center: [31.8612, 117.2831] },
            { name: '南昌', center: [28.6825, 115.8581] },
            { name: '南宁', center: [22.8170, 108.3665] },
            { name: '石家庄', center: [38.0428, 114.5149] },
            { name: '太原', center: [37.8716, 112.5489] },
            { name: '贵阳', center: [26.5972, 106.7078] },
            { name: '兰州', center: [36.0611, 103.8343] },
            { name: '乌鲁木齐', center: [43.8256, 87.6168] },
            { name: '呼和浩特', center: [40.8183, 111.6708] },
            { name: '银川', center: [38.4680, 106.2329] },
            { name: '西宁', center: [36.6232, 101.7782] },
            { name: '拉萨', center: [29.6549, 91.1761] }
        ];

        function initMap() {
            // 确保DOM完全加载后再初始化地图
            setTimeout(function() {
                map = L.map('map').setView([35.8617, 104.1954], 4);
                
                // 添加瓦片加载错误监听
                mapTypes.forEach((layer, index) => {
                    layer.on('tileerror', function(error) {
                        console.error(`瓦片图层 ${index} 加载错误:`, error);
                    });
                });
                
                mapTypes[currentMapType].addTo(map);
                
                addNaturalRegions();
                addHistoricalRegions();
                addPassages();
                addModernAdminRegions();
                
                naturalLayer.addTo(map);
                historicalLayer.addTo(map);
                passageLayer.addTo(map);
                // 现代行政区域名称默认不显示
                
                // 触发地图resize事件，确保地图正确适应容器尺寸
                setTimeout(function() {
                    map.invalidateSize();
                }, 100);
                
                console.log('地图初始化完成，当前图层:', currentMapType);
            }, 0);
        }

        function addModernAdminRegions() {
            modernAdminRegions.forEach(region => {
                L.marker(region.center, {
                    icon: L.divIcon({
                        className: 'modern-admin-label',
                        html: `<div style="font-weight: bold; color: #e74c3c; font-size: 14px; text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-shadow: 0 1px 3px rgba(255,255,255,0.9); background-color: rgba(255,255,255,0.8); padding: 2px 6px; border-radius: 4px;">${region.name}</div>`,
                        iconSize: [0, 0],
                        iconAnchor: [0, 0]
                    })
                }).addTo(modernAdminLayer);
            });
        }

        function addNaturalRegions() {
            if (typeof naturalRegions !== 'undefined' && naturalRegions.length > 0) {
                naturalRegions.forEach(region => {
                    const polygon = L.polygon(region.coordinates, {
                        color: '#27ae60',
                        fillColor: '#2ecc71',
                        fillOpacity: 0.7,
                        weight: 3,
                        opacity: 0.9,
                        dashArray: '',
                        smoothFactor: 1
                    }).addTo(naturalLayer);
                    
                    polygon.bindPopup(`
                        <div class="info-popup">
                            <h3>${region.name}</h3>
                            <h4>自然地理单元</h4>
                            <p>${region.description}</p>
                        </div>
                    `);
                    
                    // 添加区域名称标签
                    const polygonLatLngs = region.coordinates.map(coord => L.latLng(coord));
                    const bounds = L.latLngBounds(polygonLatLngs);
                    const center = bounds.getCenter();
                    
                    // 确保中心点在多边形内部
                    if (!L.polygon(polygonLatLngs).getBounds().contains(center)) {
                        // 如果中心点不在多边形内，尝试使用其他方法获取内部点
                        const points = region.coordinates;
                        // 使用第一个点作为备选
                        center.lat = points[0][0];
                        center.lng = points[0][1];
                    }
                    
                    L.marker(center, {
                        icon: L.divIcon({
                            className: 'region-label',
                            html: `<div style="font-weight: bold; color: #000; font-size: 16px; text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-shadow: 0 1px 3px rgba(255,255,255,0.8);">${region.name}</div>`,
                            iconSize: [0, 0],
                            iconAnchor: [0, 0]
                        })
                    }).addTo(naturalLayer);
                    
                    // 添加悬停效果
                    polygon.on('mouseover', function (e) {
                        this.setStyle({
                            fillOpacity: 0.9,
                            weight: 4,
                            color: '#229954'
                        });
                        this.bringToFront();
                    });
                    
                    polygon.on('mouseout', function (e) {
                        this.setStyle({
                            fillOpacity: 0.7,
                            weight: 3,
                            color: '#27ae60'
                        });
                    });
                });
            }
        }

        function addHistoricalRegions() {
            historicalRegions.forEach(region => {
                const polygon = L.polygon(region.coordinates, {
                    color: '#2980b9',
                    fillColor: '#3498db',
                    fillOpacity: 0.7,
                    weight: 3,
                    opacity: 0.9,
                    dashArray: '',
                    smoothFactor: 1
                }).addTo(historicalLayer);
                
                polygon.bindPopup(`
                    <div class="info-popup">
                        <h3>${region.name}</h3>
                        <h4>历史文化区域</h4>
                        <p>${region.description}</p>
                        <h4>历史意义</h4>
                        <p>${region.history}</p>
                    </div>
                `);
                
                // 添加区域名称标签
                const polygonLatLngs = region.coordinates.map(coord => L.latLng(coord));
                const bounds = L.latLngBounds(polygonLatLngs);
                const center = bounds.getCenter();
                
                // 确保中心点在多边形内部
                if (!L.polygon(polygonLatLngs).getBounds().contains(center)) {
                    // 如果中心点不在多边形内，尝试使用其他方法获取内部点
                    const points = region.coordinates;
                    // 使用第一个点作为备选
                    center.lat = points[0][0];
                    center.lng = points[0][1];
                }
                
                L.marker(center, {
                    icon: L.divIcon({
                        className: 'region-label',
                        html: `<div style="font-weight: bold; color: #000; font-size: 16px; text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-shadow: 0 1px 3px rgba(255,255,255,0.8);">${region.name}</div>`,
                        iconSize: [0, 0],
                        iconAnchor: [0, 0]
                    })
                }).addTo(historicalLayer);
                
                // 添加悬停效果
                polygon.on('mouseover', function (e) {
                    this.setStyle({
                        fillOpacity: 0.9,
                        weight: 4,
                        color: '#21618c'
                    });
                    this.bringToFront();
                });
                
                polygon.on('mouseout', function (e) {
                    this.setStyle({
                        fillOpacity: 0.7,
                        weight: 3,
                        color: '#2980b9'
                    });
                });
            });
        }

        function addPassages() {
            if (typeof passages !== 'undefined' && passages.length > 0) {
                passages.forEach(passage => {
                    const polygon = L.polygon(passage.coordinates, {
                        color: '#c0392b',
                        fillColor: '#e74c3c',
                        fillOpacity: 0.85,
                        weight: 4,
                        opacity: 1,
                        dashArray: '5, 5',
                        lineJoin: 'round',
                        lineCap: 'round'
                    }).addTo(passageLayer);
                    
                    polygon.bindPopup(`
                        <div class="info-popup">
                            <h3>${passage.name}</h3>
                            <h4>关键地理通道</h4>
                            <p>${passage.description}</p>
                            <h4>历史意义</h4>
                            <p>${passage.history}</p>
                        </div>
                    `);
                    
                    // 通道名称标签已在历史区域中显示，避免重复渲染
                    // 地理通道只显示多边形，不显示重复标签
                    
                    // 添加悬停效果
                    polygon.on('mouseover', function (e) {
                        this.setStyle({
                            fillOpacity: 0.95,
                            weight: 5,
                            color: '#a93226',
                            dashArray: '3, 3'
                        });
                        this.bringToFront();
                    });
                    
                    polygon.on('mouseout', function (e) {
                        this.setStyle({
                            fillOpacity: 0.85,
                            weight: 4,
                            color: '#c0392b',
                            dashArray: '5, 5'
                        });
                    });
                });
            }
        }

        function toggleLayer(layerType) {
            const button = event.target;
            button.classList.toggle('active');
            
            if (layerType === 'natural') {
                if (map.hasLayer(naturalLayer)) {
                    map.removeLayer(naturalLayer);
                } else {
                    map.addLayer(naturalLayer);
                }
            } else if (layerType === 'historical') {
                if (map.hasLayer(historicalLayer)) {
                    map.removeLayer(historicalLayer);
                } else {
                    map.addLayer(historicalLayer);
                }
            } else if (layerType === 'passage') {
                if (map.hasLayer(passageLayer)) {
                    map.removeLayer(passageLayer);
                } else {
                    map.addLayer(passageLayer);
                }
            } else if (layerType === 'modern') {
                if (map.hasLayer(modernAdminLayer)) {
                    map.removeLayer(modernAdminLayer);
                } else {
                    map.addLayer(modernAdminLayer);
                }
            }
        }

        function zoomIn() {
            map.zoomIn();
        }

        function zoomOut() {
            map.zoomOut();
        }

        function centerMap() {
            map.setView([35.8617, 104.1954], 4);
        }

        function changeDataFile() {
            // 获取选择的文件路径
            const selectElement = document.getElementById('dataSelect');
            const selectedFile = selectElement.value;
            
            // 删除可能存在的全局变量，确保切换时不会保留旧数据
            if (typeof window.naturalRegions !== 'undefined') {
                delete window.naturalRegions;
            }
            if (typeof window.historicalRegions !== 'undefined') {
                delete window.historicalRegions;
            }
            if (typeof window.passages !== 'undefined') {
                delete window.passages;
            }
            if (typeof window.modernAdminRegions !== 'undefined') {
                delete window.modernAdminRegions;
            }
            
            // 移除所有可能的地理数据脚本标签
            const existingScripts = document.querySelectorAll('script[src*="geo-data"], script[src*="custom-geo-data"]');
            existingScripts.forEach(script => script.remove());
            
            // 创建一个新的脚本标签，指向选择的文件
            const script = document.createElement('script');
            script.src = selectedFile;
            script.onload = function() {
                // 脚本加载完成后，重新加载地图数据
                reloadMapData();
            };
            document.body.appendChild(script);
        }

        function reloadMapData() {
            // 1. 彻底销毁当前地图实例
            if (map) {
                map.remove();
                map = null;
            }
            
            // 2. 清理所有相关的DOM元素
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
                mapContainer.innerHTML = '';
            }
            
            // 3. 重新初始化地图
            map = L.map('map').setView([35.8617, 104.1954], 4);
            
            // 4. 添加当前地图类型
            mapTypes.forEach((layer, index) => {
                layer.on('tileerror', function(error) {
                    console.error(`瓦片图层 ${index} 加载错误:`, error);
                });
            });
            mapTypes[currentMapType].addTo(map);
            
            // 5. 重新创建所有图层对象
            naturalLayer = L.layerGroup();
            historicalLayer = L.layerGroup();
            passageLayer = L.layerGroup();
            modernAdminLayer = L.layerGroup();
            
            // 6. 重新加载所有数据
            addNaturalRegions();
            addHistoricalRegions();
            addPassages();
            
            // 7. 将新图层添加到地图
            naturalLayer.addTo(map);
            historicalLayer.addTo(map);
            passageLayer.addTo(map);
            
            // 8. 触发地图resize事件，确保地图正确适应容器尺寸
            setTimeout(function() {
                map.invalidateSize();
            }, 100);
        }

        function changeMapType() {
            currentMapType = (currentMapType + 1) % mapTypes.length;
            map.removeLayer(mapTypes[(currentMapType - 1 + mapTypes.length) % mapTypes.length]);
            mapTypes[currentMapType].addTo(map);
        }

        window.onload = function() {
            initMap();
        };
    </script>
</body>
</html>